Acumulus module events
=======================

Warning
=======
The events are experimental. Depending on feedback from actual usage, details
may change in future versions!


Introduction
============
This file documents the events that the Acumulus module defines. Currently, 3
events are defined:
- acumulus_invoice_created
- acumulus_invoice_completed
- acumulus_invoice_sent

The event acumulus_invoice_created is triggered when the invoice has been
created with raw data from the webshop order or credit memo, but  has yet to be
completed and refined. Use this event when you want to do some completion
yourself. This should be rare and most of the times the
acumulus_invoice_completed event should be preferred.

The event acumulus_invoice_completed is triggered when the invoice has been
completed. Some defaults have been added; VAT rates have been corrected for
rounding errors; and the 'vat type' has been determined.

Typical usages for the latter event allow to implement business logic specific
to your business, think of:
- Template, account number, or cost center selection based on order specifics.
- Adding descriptive info to the invoice or invoice lines based on custom order
  meta data.
- Correcting payment info based on payment modules not supported by this module.

The event acumulus_invoice_sent is triggered when the invoice has been sent to
Acumulus. This allows to perform some actions depending on the result. Note that
this event is called independent of the result, so on success as well as
failure.

Typical usages for this event allow to use the invoice number assigned by
Acumulus in your webshop or to link your order to Acumulus info, although
this is also already done by this module itself.


acumulus_invoice_created
========================

Usage
-----
When the "acumulus_invoice_created" event is called, it is passed 3 arguments:
- invoice:
  A keyed array - passed by reference - containing the invoice that will be sent
  to Acumulus. The array structure is similar to the XML structure as defined on
  https://apidoc.sielsystems.nl/content/invoice-add, though at this stage, only
  the customer key will be present at the highest level. The line tag is
  represented as a numeric array of lines, even if if there is only 1 line.

  Some keys will be missing, if they are still missing after this event has
  been applied, they will be filled in (not overwritten) by the Completor before
  the actual sending takes place:
  - ['customer']['locationcode']
  - ['customer']['overwriteifexists']
  - ['customer']['type']
  - ['customer']['invoice']['concept']
  - ['customer']['invoice']['accountnumber']
  - ['customer']['invoice']['costcenter']
  - ['customer']['invoice']['template]
  - ['customer']['invoice']['vattype]

  The following keys may be filled with a null value, if the 'unitprice' of that
  'line' = 0. These null values will be replaced by the module by the most
  occurring vat rate before the actual sending takes place:
  - ['customer']['invoice']['line']['vatrate']
- source: The Acumulus \Siel\Acumulus\Invoice\Source object that wraps the base
  Order or CreditNote of the invoice to be sent.
- localResult: A \Siel\Acumulus\Invoice\Result object that at this stage can
  only contain local warnings (and errors).


acumulus_invoice_completed
==========================

Usage
-----
When the "acumulus_invoice_completed" event is called, it is passed 3 arguments:
- invoice:
  A keyed array - passed by reference - containing the invoice that will be sent
  to Acumulus. The array structure is similar to the XML structure as defined on
  https://apidoc.sielsystems.nl/content/invoice-add, though at this stage, only
  the customer key will be present at the highest level. The line tag is
  represented as a numeric array of lines, even if if there is only 1 line.
- source: The Acumulus \Siel\Acumulus\Invoice\Source object that wraps the base
  Order or CreditNote of the invoice to be sent.
- localResult: A \Siel\Acumulus\Invoice\Result object that at this stage can
  only contain local warnings (and errors).

Example
-------
app\code\VendorName\ModuleName\etc\events.xml:
<?xml version='1.0'?>
<config xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:noNamespaceSchemaLocation='../../../../../vendor/magento/framework/Event/etc/events.xsd'>
    <event name="acumulus_invoice_completed">
        <observer name="vendorname_modulename_acumulus_invoice_completed_observer" instance="VendorName\ModuleName\Observer\AcumulusInvoiceCompleted"/>
    </event>
</config>

app\code\VendorName\ModuleName\Observer\Acumulus\AcumulusInvoiceCompleted.php:
use Siel\AcumulusMa2\Invoice\Source;

class VendorName\ModuleName\Observer\AcumulusInvoiceCompleted implements ObserverInterface
{
    public function execute(EventObserver $observer)
    {
        $event = $observer->getEvent();
        /** @var array $invoice */
        /** @noinspection PhpUndefinedMethodInspection */
        $invoice = $event->getInvoice();
        /** @var \Siel\Acumulus\Invoice\Source $source */
        /** @noinspection PhpUndefinedMethodInspection */
        $source = $event->getSource();
        /** @var \Siel\Acumulus\Invoice\Result $localResult */
        /** @noinspection PhpUndefinedMethodInspection */
        $localResult = $observer->getLocalResult();

        if ($localResult->hasErrors() {
            // Invoice will not be sent
        }
        elseif ($localResult->hasMessages() {
            // Invoice will be sent but warnings will be issued.
        }

        if ($source->getType() === Source::Order) {
            // Process order.
            /** @var \Magento\Sales\Model\Order $order */
            $order = $source->getSource();
            $invoice['test'] = 'order test';
        }
        else { // $source->getType() === Source::CreditNote
            // Process credit memo.
            /** @var \Magento\Sales\Model\Order\Creditmemo $creditmemo */
            $creditmemo = $source->getSource();
            $invoice['test'] = 'creditmemo test';
        }

        // Make sure that the changes on the invoice are returned.
        $observer->setInvoice($invoice);

        // Or prevent sending this invoice:
        // $observer->setInvoice(null);
  }
}


acumulus_invoice_sent
=====================

Usage
-----
When the "acumulus_invoice_sent" event is called, it is passed 3 arguments:
- invoice:
  A keyed array containing the invoice that has been sent to Acumulus. The array
  structure is similar to the XML structure as defined on
  https://apidoc.sielsystems.nl/content/invoice-add. The line tag is represented
  as a numeric array of lines, even if if there is only 1 line.
- source: The Acumulus \Siel\Acumulus\Invoice\Source object that wraps the base
  Order or CreditNote of the invoice to be sent.
- result: A \Siel\Acumulus\Invoice\Result object that contains a.o. any warnings,
  errors and exceptions as well as the result as sent back by Acumulus, see
  https://apidoc.sielsystems.nl/content/invoice-add.

Example
-------
app\code\VendorName\ModuleName\etc\events.xml:
<?xml version='1.0'?>
<config xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:noNamespaceSchemaLocation='../../../../../vendor/magento/framework/Event/etc/events.xsd'>
    <event name="acumulus_invoice_completed">
        <observer name="vendorname_modulename_acumulus_invoice_completed_observer" instance="VendorName\ModuleName\Observer\AcumulusInvoiceCompleted"/>
    </event>
</config>

app\code\VendorName\ModuleName\Observer\Acumulus\AcumulusInvoiceCompleted.php:
use Siel\AcumulusMa2\Invoice\Source;

class VendorName\ModuleName\Observer\AcumulusInvoiceCompleted implements ObserverInterface
{
    public function execute(EventObserver $observer)
    {
        $event = $observer->getEvent();
        /** @var array $invoice */
        /** @noinspection PhpUndefinedMethodInspection */
        $invoice = $event->getInvoice();
        /** @var \Siel\Acumulus\Invoice\Source $source */
        /** @noinspection PhpUndefinedMethodInspection */
        $source = $event->getSource();
        /** @var \Siel\Acumulus\Invoice\Result $result */
        /** @noinspection PhpUndefinedMethodInspection */
        $result = $observer->getResult();

        if ($result->hasErrors() {
            // Failure.
        }
        else {
            $acumulusInvoice = $result->getResult();
            if (!empty($acumulusInvoice['invoicenumber']) {
                // Success.
                $acumulusInvoiceNumber = $acumulusInvoice['invoicenumber'];
                $acumulusEntryId = $acumulusInvoice['entryid'];
                $acumulusToken = $acumulusInvoice['token'];
                // Do something with this info.
            }
            else {
                // Sent in test mode or as concept
            }
        }
    }
}


External Resources
==================
- https://apidoc.sielsystems.nl/content/invoice-add.
- https://apidoc.sielsystems.nl/content/warning-error-and-status-response-section-most-api-calls
